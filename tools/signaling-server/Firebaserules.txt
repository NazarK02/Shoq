rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users collection
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Friend requests collection
    match /friendRequests/{requestId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null;
    }

    // Public Friend ID registry (helps guarantee uniqueness)
    match /friendIdRegistry/{friendIdLower} {
      allow read: if request.auth != null;
      allow create: if request.auth != null &&
        request.resource.data.uid == request.auth.uid &&
        !exists(/databases/$(database)/documents/friendIdRegistry/$(friendIdLower));
      allow update, delete: if false;
    }

    // Contacts collection (friends)
    match /contacts/{userId}/friends/{friendId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == friendId;
      allow delete: if request.auth != null &&
                       (request.auth.uid == userId || request.auth.uid == friendId);
    }

    // Blocked users collection
    match /contacts/{userId}/blocked/{blockedId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Notifications
    match /notifications/{notificationId} {
      allow create: if request.auth != null;
      allow read, update: if request.auth != null &&
                         resource.data.recipientId == request.auth.uid;
    }

    // Notifications settings
    match /users/{userId}/settings/{document} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Conversations
    match /conversations/{conversationId} {
      allow create: if request.auth != null &&
        request.resource.data.participants is list &&
        request.auth.uid in request.resource.data.participants;

      allow read, update: if request.auth != null &&
        request.auth.uid in resource.data.participants;

      match /messages/{messageId} {
        function isConversationParticipant() {
          return request.auth != null &&
            request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
        }

        function reactionsOrEmpty(data) {
          return data.reactions is map ? data.reactions : {};
        }

        function isReadReceiptUpdate() {
          return request.resource.data.diff(resource.data).changedKeys().hasOnly(['read', 'readAt']) &&
            request.resource.data.read == true;
        }

        function isOwnReactionUpdate() {
          let before = reactionsOrEmpty(resource.data);
          let after = reactionsOrEmpty(request.resource.data);
          let reactionDiff = after.diff(before);
          return request.resource.data.diff(resource.data).changedKeys().hasOnly(['reactions']) &&
            reactionDiff.addedKeys().hasOnly([request.auth.uid]) &&
            reactionDiff.changedKeys().hasOnly([request.auth.uid]) &&
            reactionDiff.removedKeys().hasOnly([request.auth.uid]) &&
            (
              !(request.auth.uid in after) ||
              after[request.auth.uid] is string
            );
        }

        allow read: if request.auth != null &&
          request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;

        allow create: if request.auth != null &&
          request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants &&
          request.auth.uid == request.resource.data.senderId &&
          (
            // Encrypted text
            (request.resource.data.type == 'text' &&
             request.resource.data.encrypted == true &&
             (
               request.resource.data.ciphertext is string ||
               request.resource.data.ciphertexts is map
             ) &&
             (
               !('senderCiphertext' in request.resource.data) ||
               request.resource.data.senderCiphertext is string
             ) &&
             (
               !('senderCiphertexts' in request.resource.data) ||
               request.resource.data.senderCiphertexts is map
             ) &&
             (
               !('senderPublicKey' in request.resource.data) ||
               request.resource.data.senderPublicKey is string
             ))

            ||

            // File message
            (request.resource.data.type == 'file' &&
             request.resource.data.encrypted == false &&
             request.resource.data.fileUrl is string &&
             request.resource.data.fileName is string &&
             (request.resource.data.fileSize is int || request.resource.data.fileSize is number) &&
             request.resource.data.mimeType is string &&
             request.resource.data.storagePath is string)
          );

        allow update: if isConversationParticipant() &&
          (
            request.auth.uid == resource.data.senderId ||
            isReadReceiptUpdate() ||
            isOwnReactionUpdate()
          );

        allow delete: if request.auth != null &&
          request.auth.uid == resource.data.senderId;
      }
    }
  }
}
